<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- HTML 파일 문서 호환성을 edge버전으로 통일-->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> <!-- HTML 4.0.1 버전 기준 문자인코딩 방식 정의 -->
  <!-- 현재 사용자가 접속한 디바이스의 가로 세로 길이에 맞게 앱 사이즈를 조절함. 초기, 최대, 최소 비율은 모두 1이며, 사용자가 드레그로 크기 조정 불가능-->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, minimum-scale = 1.0, user-scalable=no">

  <!-- CSS 정의 -->
  <link rel = "stylesheet" href = "css/init.css">
  <link rel = "stylesheet" href = "css/admin/admin.css">

  <!-- 카카오 API를 사용하기 위한 라이브러리 선언-->
  <script type="text/JavaScript" src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
  <script> Kakao.init('2e39201190179fe7cd5eb25903daba8a'); </script> <!--SDK를 초기화 (애플리케이션>앱설정>앱키:JAVASCRIPTKEY -->

  <!-- 자바스크립트 함수 정의 -->
  <script src = "../../JavaScript/unlinkWithKakao.js"></script>
  <script src = "../../JavaScript/loginAram.js"></script>
  <script src = "../../JavaScript/loadingOn.js"></script>
  <script src = "../../JavaScript/loadingOff.js"></script>

  <script src = "../../JavaScript/createCardStored.js"></script>
  <script src = "../../JavaScript/modifyBtn.js"></script>
  <script src = "../../JavaScript/newBtn.js"></script>
  <title>Modify schedule</title>

</head>
<script>
</script>

<body id = "body">
<!-- 메인 해더-->
<header id = "header">
  <img id = "header_sk" src="css/images/Ghost.png" alt = "location images"> <!-- GHOST 트레이드 마크 -->
  <span id = "header_logo">SK GHOST Admin</span> <!-- GHOST text -->
</header>

<section id = "section_date">
  <h1 id="startDate" th:text="${start}"></h1>
  <h1 id="endDate" th:text="${end}"></h1>
</section>

<!-- 전체 seciton은 top과 bottom으로 구성된다.-->
<section id="section_top">
  <div id="image-container">

  </div>
</section>

<!-- 메인 푸터  -->
<footer id = "footer">
  <!-- 스케줄 수정 취소 -->
  <button id = "modify_cancel" onClick="">
    <span id = "text1">Cancel</span>
  </button>

  <!-- 스케줄 수정 저장 -->
  <button id = "modify_save" onClick="newBtn()">
    <span id = "text2">Done</span>
  </button>
</footer>
</body>

<script>
  function getDates(startDate, endDate) {
    const dateArray = [];
    let currentDate = startDate;

    // 날짜 간의 범위를 계산하며 배열에 추가
    while (currentDate <= endDate) {
      dateArray.push(currentDate.toISOString().split('T')[0]);
      currentDate.setDate(currentDate.getDate() + 1);
    }
    return dateArray;
  }
</script>

<script>
  let userId;
  let userImage;
  let noFlag = false; // 수정할 페이지가 하나도 없다면 false
  // 사용자가 OP 페이지에 들어오면 카카오톡 프로필, 이름을 애니메이션으로 보여준다.
  Kakao.Auth.getStatusInfo(function(statusObj) {
    if (statusObj.status === 'connected') {
      userId = statusObj.user.properties.nickname
      userImage = statusObj.user.kakao_account.profile.profile_image_url

      // 시작일과 종료일의 input 요소를 가져옴
      const startDay = document.getElementById('startDate');
      const endDay = document.getElementById('endDate');


      // 시작일과 종료일의 값을 가져옴
      const startDateString = startDay.innerText;
      const endDateString = endDay.innerText;

      // 값을 console에 출력
      const startDate = new Date(startDateString);
      const endDate = new Date(endDateString);
      console.log('시작일:', startDateString);
      console.log('종료일:', endDateString);
      //console.log(getDates(startDate, endDate));
      let cards = getDates(startDate, endDate);
      console.log(cards)

      // 순차적으로 비동기 작업을 수행하는 함수
      async function processCards() {
        for (let card of cards) {
          await processCard(card);
        }

        if (!noFlag) {
          alert("현재 날짜 범위는 스케줄이 없습니다.\n New로 생성하세요!")
        }
      }

      // 각 날짜에 대한 비동기 작업을 수행하는 함수
      function processCard(card) {
        return new Promise(resolve => {
          let xhr1 = new XMLHttpRequest();
          let payloadFront = {"date": card};
          xhr1.open('POST', '/getSchedule', true);
          xhr1.setRequestHeader("Content-Type", "application/json");
          xhr1.send(JSON.stringify(payloadFront));

          xhr1.onload = function () {
            let results = JSON.parse(xhr1.response);
            console.log(results);

            const dateObject = new Date(`${card}T00:00:00-05:00`);
            const options = {weekday: 'short', timeZone: 'America/New_York'};
            const dayOfWeek = dateObject.toLocaleDateString('en-US', options);

            if (results.length !== 0) {
              noFlag = true
              // DOM 에서 동적으로 카드를 생성하여 부모 컨테이너에 삽입
              createCardStored(results, dayOfWeek, card, false);
            }


            resolve();
          }
        });
      }

      // 비동기 작업을 순차적으로 실행
      processCards();

    }
  })
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let container = document.getElementById('image-container');

    container.addEventListener('wheel', function (e) {
      container.scrollLeft += e.deltaY;
      e.preventDefault();
    });
  });
</script>

</html>